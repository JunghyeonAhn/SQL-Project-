/* Title:  2. Product-Centric Analysis 
   Description : 

    [Cleaning Step]
    1. Overview Total revenue 
    2. Top 10 Purchased items
	3. Top 3 Sales items by Country 
	4. Top 3 sales items by Months
*/

- 1. Overview Total revenue 
SELECT 
	Description,	
	SUM(quantity) AS orders,
	ROUND(SUM(Unitprice*Quantity),1) AS revenue,
	ROUND(AVG(Unitprice*Quantity),2) AS AOV,
	MAX(FinalInvoiceDate) AS latest_sale_date
FROM NEW_DATA 
GROUP BY Description
ORDER BY revenue desc

- 2. Top 10 Purchased items
SELECT 
	Description,	
	SUM(quantity) AS orders,
	ROUND(SUM(Unitprice*Quantity),1) AS revenue,
	ROUND(AVG(Unitprice*Quantity),2) AS AOV,
	MAX(FinalInvoiceDate) AS latest_sale_date
FROM NEW_DATA 
GROUP BY Description
ORDER BY revenue desc
LIMIT 10;


- 3. Top 3 Sales items by Country
SELECT 
	Country,
	Description,
	orders,
	revenue,
	AOV
FROM (
	SELECT 
		Country,
		Description,
		SUM(quantity) AS orders,
		ROUND(SUM(Unitprice*Quantity),1) AS revenue,
		ROUND(AVG(Unitprice*Quantity),2) AS AOV,
	RANK() OVER (
		PARTITION BY Country
		ORDER BY SUM(quantity) DESC
	) AS country_rank
FROM NEW_DATA
GROUP BY Country, Description
)
WHERE country_rank <= 3
ORDER BY Country ASC, revenue DESC;



- 4. Top 3 sales items by Months
WITH Monthly_Sales AS (
	SELECT
		Description,
		SUBSTR(FinalInvoiceDate, 1, 7) AS sales_month, 
        ROUND(SUM(Quantity*Unitprice),1) AS monthly_revenue
	FROM NEW_DATA
	GROUP BY sales_month, Description 
),
Ranked_Sales AS ( 
	SELECT
		Description,
		sales_month,
		monthly_revenue,
		RANK() OVER( 
			PARTITION BY sales_month
			ORDER BY monthly_revenue DESC 
		) AS month_rank
	FROM Monthly_Sales
)
SELECT 
	sales_month,
    Description,
    monthly_revenue
FROM Ranked_Sales
WHERE month_rank <= 3
ORDER BY sales_month ASC, monthly_revenue DESC;


